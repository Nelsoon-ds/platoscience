<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Interactive Neurofeedback Provider Directory</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap"
            rel="stylesheet"
        />
        <style>
            body {
                font-family: "Inter", sans-serif;
                background-color: #f8f7f4;
                color: #3d405b;
            }
            .nav-button {
                transition: all 0.3s ease;
                border-bottom: 2px solid transparent;
            }
            .nav-button.active,
            .nav-button:hover {
                border-bottom-color: #81b29a;
                color: #3d405b;
            }
            .goal-card {
                transition: transform 0.3s ease, box-shadow 0.3s ease;
            }
            .goal-card:hover {
                transform: translateY(-5px);
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1),
                    0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }
            .chart-container {
                position: relative;
                width: 100%;
                max-width: 800px;
                margin-left: auto;
                margin-right: auto;
                height: 350px;
                max-height: 50vh;
            }
            @media (min-width: 768px) {
                .chart-container {
                    height: 450px;
                }
            }
            .table-link {
                color: #81b29a;
                text-decoration: none;
                transition: color 0.2s;
            }
            .table-link:hover {
                color: #6a947e;
            }
            .filter-btn.active {
                background-color: #3d405b;
                color: #f4f1de;
            }
            .filter-btn {
                transition: all 0.2s ease-in-out;
            }
            /* Style for accordion icon rotation */
            .accordion-icon.rotate-45 {
                transform: rotate(45deg);
            }
        </style>
    </head>
    <body class="antialiased">
        <div class="min-h-screen">
            <header
                class="bg-white/80 backdrop-blur-lg shadow-sm sticky top-0 z-20"
            >
                <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-16">
                        <h1 class="text-2xl font-bold text-[#3d405b]">
                            Neurofeedback Provider Directory
                        </h1>
                        <nav class="hidden md:flex space-x-8" id="desktop-nav">
                            <button
                                data-view="dashboard"
                                class="nav-button active"
                            >
                                Dashboard
                            </button>
                            <button data-view="directory" class="nav-button">
                                Full Directory
                            </button>
                            <button data-view="regional" class="nav-button">
                                Regional Analysis
                            </button>
                        </nav>
                        <div class="md:hidden">
                            <select
                                id="mobile-nav"
                                class="bg-white border border-gray-300 rounded-md py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:ring-2 focus:ring-[#81b29a] focus:border-transparent"
                            >
                                <option value="dashboard">Dashboard</option>
                                <option value="directory">
                                    Full Directory
                                </option>
                                <option value="regional">
                                    Regional Analysis
                                </option>
                            </select>
                        </div>
                    </div>
                </div>
            </header>

            <main id="main-content" class="container mx-auto p-4 sm:p-6 lg:p-8">
                <div id="dashboard-view">
                    <section id="intro" class="text-center mb-12">
                        <h2
                            class="text-4xl font-bold tracking-tight text-[#3d405b] sm:text-5xl"
                        >
                            Navigate a Fragmented Landscape
                        </h2>
                        <p
                            class="mt-6 text-lg leading-8 text-gray-600 max-w-3xl mx-auto"
                        >
                            The global provider ecosystem for QEEG, EEG, and
                            neurofeedback is a complex mosaic of distinct, often
                            overlapping, communities. This interactive tool is
                            designed to help you find the right providers by
                            aligning your search with your strategic goals.
                        </p>
                    </section>

                    <section id="goal-selector" class="mb-12">
                        <h3
                            class="text-2xl font-semibold text-center mb-8 text-[#3d405b]"
                        >
                            What is Your Primary Objective?
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                            <div
                                data-goal="sales"
                                class="goal-card cursor-pointer bg-white p-8 rounded-xl shadow-md border border-transparent hover:border-[#e07a5f]"
                            >
                                <div class="text-3xl mb-4 text-[#e07a5f]">
                                    üìà
                                </div>
                                <h4 class="text-xl font-bold mb-2">
                                    Mass-Market Sales
                                </h4>
                                <p class="text-gray-600">
                                    Generate the largest possible list of
                                    commercially active providers for marketing
                                    campaigns and broad outreach.
                                </p>
                            </div>
                            <div
                                data-goal="partnership"
                                class="goal-card cursor-pointer bg-white p-8 rounded-xl shadow-md border border-transparent hover:border-[#81b29a]"
                            >
                                <div class="text-3xl mb-4 text-[#81b29a]">
                                    ü§ù
                                </div>
                                <h4 class="text-xl font-bold mb-2">
                                    High-Quality Partnerships
                                </h4>
                                <p class="text-gray-600">
                                    Identify credible, certified, and
                                    professionally active providers for
                                    partnerships or reference sites.
                                </p>
                            </div>
                            <div
                                data-goal="research"
                                class="goal-card cursor-pointer bg-white p-8 rounded-xl shadow-md border border-transparent hover:border-[#3d405b]"
                            >
                                <div class="text-3xl mb-4 text-[#3d405b]">
                                    üî¨
                                </div>
                                <h4 class="text-xl font-bold mb-2">
                                    Scientific Engagement
                                </h4>
                                <p class="text-gray-600">
                                    Find top-tier academic and clinical
                                    researchers (KOLs) for scientific advisory
                                    or validation studies.
                                </p>
                            </div>
                        </div>
                    </section>

                    <section
                        id="strategy-display"
                        class="bg-white p-8 rounded-xl shadow-lg mb-12"
                        style="display: none"
                    >
                        <div class="flex justify-between items-start">
                            <h3
                                id="strategy-title"
                                class="text-2xl font-bold text-[#3d405b] mb-4"
                            ></h3>
                            <button
                                id="reset-dashboard-btn"
                                class="text-gray-500 hover:text-gray-800"
                            >
                                &times; Reset
                            </button>
                        </div>
                        <p
                            id="strategy-text"
                            class="text-gray-700 leading-relaxed"
                        ></p>
                    </section>

                    <section
                        id="comparison-chart"
                        class="mb-12 bg-white p-6 rounded-xl shadow-lg"
                    >
                        <h3
                            class="text-2xl font-semibold text-center mb-2 text-[#3d405b]"
                        >
                            Source Category Analysis
                        </h3>
                        <p class="text-center text-gray-600 mb-6">
                            Compare directory types by their potential for lead
                            volume versus quality.
                        </p>
                        <div class="chart-container">
                            <canvas id="sourceComparisonChart"></canvas>
                        </div>
                    </section>
                </div>

                <div id="directory-view" style="display: none">
                    <section id="directory-table-section">
                        <h2
                            class="text-3xl font-bold text-center mb-4 text-[#3d405b]"
                        >
                            Comprehensive Provider Directory
                        </h2>
                        <p
                            class="text-center text-gray-600 mb-8 max-w-3xl mx-auto"
                        >
                            This directory compiles all identified resources.
                            Use the filters to narrow your search by source
                            category or use the search box to find specific
                            keywords. Each source category has unique strengths
                            for finding providers.
                        </p>
                        <div class="bg-white p-6 rounded-xl shadow-lg">
                            <div
                                class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4"
                            >
                                <div
                                    class="w-full md:w-auto flex flex-wrap gap-2 justify-center"
                                    id="filter-buttons"
                                ></div>
                                <input
                                    type="text"
                                    id="searchInput"
                                    placeholder="Search directory..."
                                    class="w-full md:w-1/3 p-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-[#81b29a] focus:outline-none"
                                />
                            </div>
                            <div class="overflow-x-auto">
                                <table
                                    class="min-w-full divide-y divide-gray-200"
                                >
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th
                                                scope="col"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                            >
                                                Directory Name
                                            </th>
                                            <th
                                                scope="col"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                            >
                                                Category
                                            </th>
                                            <th
                                                scope="col"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                            >
                                                Focus
                                            </th>
                                            <th
                                                scope="col"
                                                class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider"
                                            >
                                                Notes
                                            </th>
                                        </tr>
                                    </thead>
                                    <tbody
                                        id="directory-tbody"
                                        class="bg-white divide-y divide-gray-200"
                                    ></tbody>
                                </table>
                            </div>
                        </div>
                    </section>
                </div>

                <div id="regional-view" style="display: none">
                    <section id="regional-analysis-section">
                        <h2
                            class="text-3xl font-bold text-center mb-4 text-[#3d405b]"
                        >
                            Regional Market Analysis
                        </h2>
                        <p
                            class="text-center text-gray-600 mb-8 max-w-3xl mx-auto"
                        >
                            The provider landscape varies significantly by
                            region. Select a market below to understand its
                            unique characteristics, level of maturity, and key
                            resources for provider identification.
                        </p>
                        <div class="max-w-4xl mx-auto">
                            <div id="accordion-container"></div>
                        </div>
                    </section>
                </div>
            </main>
        </div>

        <script defer>
            // Defer script execution until the document is parsed
            document.addEventListener("DOMContentLoaded", () => {
                // --- DATA STORE ---
                const directoryData = [
                    {
                        name: "BrainMaster Practitioner Finder",
                        url: "https://brainmaster.com/find-a-clinician/",
                        category: "Manufacturer",
                        focus: "Global",
                        notes: "Ecosystem for BrainMaster hardware/software. Good for finding users of a specific platform.",
                    },
                    {
                        name: "Neuroelectrics Distributor List",
                        url: "https://www.neuroelectrics.com/about-us/distributors",
                        category: "Manufacturer",
                        focus: "Global",
                        notes: "B2B list of regional distributors, not end-user clinicians. Requires a two-step approach.",
                    },
                    {
                        name: "ANT Neuro Offices",
                        url: "https://www.medicalexpo.com/soc/ant-neuro-84713.html",
                        category: "Manufacturer",
                        focus: "Global",
                        notes: "Lists direct corporate offices in key markets (NL, DE, UK, US, HK, AU). B2B focus.",
                    },
                    {
                        name: "Medtronic Find a Specialist",
                        url: "https://www.medtronic.com/en-us/e/locator-neuro.html",
                        category: "Manufacturer",
                        focus: "Global",
                        notes: "Broad neuroscience tool. Not specific to EEG/neurofeedback; low signal-to-noise ratio.",
                    },
                    {
                        name: "ISNR Find a Provider",
                        url: "https://isnr.org/find-a-provider",
                        category: "Professional Society",
                        focus: "Global",
                        notes: "High-volume directory. Membership is open; does not certify competence. Excellent starting point.",
                    },
                    {
                        name: "ISNR Member Directory",
                        url: "https://isnr.org/member-directory",
                        category: "Professional Society",
                        focus: "Global",
                        notes: "More comprehensive than the 'Find a Provider' list. Searchable by geography and specialty.",
                    },
                    {
                        name: "BCIA Find a Practitioner",
                        url: "https://www.bcia.org/consumers-find-a-practitioner",
                        category: "Certification Body",
                        focus: "Global",
                        notes: "Gold standard for quality. Lists certified professionals (BCN) and licensure status (-L vs. -P).",
                    },
                    {
                        name: "ANSA Find a Practitioner",
                        url: "https://appliedneuroscience.org.au/page-65872",
                        category: "Professional Society",
                        focus: "Australia",
                        notes: "Key directory for the Australian market. Advises cross-referencing with BCIA-A.",
                    },
                    {
                        name: "Foundation for Neurofeedback",
                        url: "https://neurofeedbackfoundation.org/find-a-provider",
                        category: "Professional Society",
                        focus: "Global",
                        notes: "A meta-directory; provides a valuable list of links to other society and regional directories.",
                    },
                    {
                        name: "Psychology Today (Neurofeedback)",
                        url: "https://www.psychologytoday.com/us/therapists?category=neurofeedback",
                        category: "Patient/Commercial",
                        focus: "Global",
                        notes: "Very high volume. Excellent for gauging commercial activity and market density. Self-reported quality.",
                    },
                    {
                        name: "National Neurofeedback Network",
                        url: "https://www.nationalneurofeedbacknetwork.com/directory/",
                        category: "Patient/Commercial",
                        focus: "USA",
                        notes: "High-volume, high-relevance directory specifically for US neurofeedback providers.",
                    },
                    {
                        name: "EEG Info Provider Listing",
                        url: "http://www.eeginfo.com/directory",
                        category: "Patient/Commercial",
                        focus: "Global",
                        notes: "Commercial directory linked to the Othmer Method training ecosystem. Filterable by method/equipment.",
                    },
                    {
                        name: "Applied Neuroscience Provider Maps",
                        url: "https://appliedneuroscience.com/internatl-provider-map/",
                        category: "Patient/Commercial",
                        focus: "Global",
                        notes: "Maps of providers using the company's specific NeuroGuide software and methods.",
                    },
                    {
                        name: "ClinicalTrials.gov",
                        url: "https://clinicaltrials.gov/",
                        category: "Academic/Research",
                        focus: "Global",
                        notes: "Premier source for KOLs. Searchable database of clinical trials, PIs, and institutions.",
                    },
                    {
                        name: "EU Clinical Trials Register",
                        url: "https://www.clinicaltrialsregister.eu/",
                        category: "Academic/Research",
                        focus: "Europe",
                        notes: "European equivalent of ClinicalTrials.gov. Essential for identifying European KOLs and research hubs.",
                    },
                    {
                        name: "EBRAINS Lab Visits Directory",
                        url: "https://www.ebrains.eu/page/lab-visits-directory",
                        category: "Academic/Research",
                        focus: "Europe",
                        notes: "Directory of European neuroscience labs, often listing research focus and PIs.",
                    },
                    {
                        name: "FENS NENS Directory",
                        url: "https://www.fens.org/careers/networks/nens/nens-directory",
                        category: "Academic/Research",
                        focus: "Europe",
                        notes: "Comprehensive list of European neuroscience graduate programs and schools.",
                    },
                ];

                const sourceComparisonData = [
                    // Added a 'filterCategory' to make the click handler robust.
                    {
                        label: "Manufacturer Networks",
                        x: 2.5,
                        y: 3,
                        color: "#f94144",
                        filterCategory: "Manufacturer",
                    },
                    {
                        label: "Professional Society Rosters",
                        x: 4,
                        y: 3,
                        color: "#f3722c",
                        filterCategory: "Professional Society",
                    },
                    {
                        label: "Certification Body (BCIA)",
                        x: 3,
                        y: 4.5,
                        color: "#81b29a",
                        filterCategory: "Certification Body",
                    },
                    {
                        label: "Patient/Commercial Directories",
                        x: 5,
                        y: 2,
                        color: "#f8961e",
                        filterCategory: "Patient/Commercial",
                    },
                    {
                        label: "Academic/Research Networks",
                        x: 1,
                        y: 5,
                        color: "#3d405b",
                        filterCategory: "Academic/Research",
                    },
                ];

                const regionalData = [
                    {
                        name: "North America",
                        content:
                            "The most mature, diverse, and well-documented market. All source categories are strongly represented. It hosts key bodies like ISNR and BCIA, and has robust commercial directories like Psychology Today and the National Neurofeedback Network. It's a high-volume, high-opportunity market requiring a multi-pronged search strategy.",
                    },
                    {
                        name: "United Kingdom",
                        content:
                            "A well-developed market with a blend of NHS involvement and a growing private sector. Major private health groups (Nuffield Health) offer EEG, and specialized clinics (Brainworks) provide innovative at-home services. Commercial directories and academic centers are strong, making it an accessible market.",
                    },
                    {
                        name: "Germany",
                        content:
                            "A highly organized market strongly influenced by training institutes (AfN, IFEN) and manufacturers (Mindfield). Provider networks are often built around shared educational backgrounds or technology platforms. A targeted approach focusing on local academies and manufacturers is most effective.",
                    },
                    {
                        name: "Australia",
                        content:
                            "A vibrant, community-driven market anchored by the Applied Neuroscience Society of Australasia (ANSA). There is a strong emphasis on quality control, with recommendations to verify credentials with BCIA-Australia. Providers clearly advertise advanced services like QEEG, indicating a mature market.",
                    },
                    {
                        name: "Scandinavian Region",
                        content:
                            "A more fragmented and less visible online market. Sweden is the most developed, while Denmark is less visible. Provider identification requires a bottom-up approach, focusing on regional distributors, local training affiliates, and keyword searches in local languages. A top-down search from global directories is less effective here.",
                    },
                ];

                const strategies = {
                    sales: {
                        title: "Strategy: Mass-Market Sales Campaign",
                        text: "To generate the largest possible list of commercially active providers, focus on maximizing reach and volume. Start with the highest-volume commercial directories like Psychology Today and the National Neurofeedback Network, as these capture providers with clear commercial intent. Supplement this list by acquiring member directories from major professional societies like ISNR to add individuals from the core professional community. This combined list is ideal for large-scale marketing campaigns and broad market-sizing analysis.",
                        categories: [
                            "Patient/Commercial",
                            "Professional Society",
                        ],
                    },
                    partnership: {
                        title: "Strategy: High-Quality Partnership Development",
                        text: "To identify credible and professionally active providers for partnerships, focus on quality over volume. Start with the 'gold standard' source: the BCIA provider directory, prioritizing licensed (BCN-L) professionals. Cross-reference this list against member directories of societies like ISNR to find providers who are both certified and community-engaged. A final check on commercial directories can identify those who are also growth-oriented. This yields a 'Tier 1' list of the most desirable clinical partners.",
                        categories: [
                            "Certification Body",
                            "Professional Society",
                            "Manufacturer",
                        ],
                    },
                    research: {
                        title: "Strategy: Key Opinion Leader (KOL) Engagement",
                        text: "To identify top-tier academic and clinical researchers, focus on sources that highlight innovation and scientific validation. Systematically search clinical trial registries (ClinicalTrials.gov, EU Clinical Trials Register) to find Principal Investigators and their institutions. Supplement this by identifying senior authors of highly-cited research papers on academic databases. These individuals are not sales targets; they are strategic assets for scientific advisory boards and validation studies.",
                        categories: ["Academic/Research"],
                    },
                };

                // --- STATE MANAGEMENT ---
                let chart;
                let currentFilter = "All";

                // --- DOM ELEMENT CACHING ---
                const views = {
                    dashboard: document.getElementById("dashboard-view"),
                    directory: document.getElementById("directory-view"),
                    regional: document.getElementById("regional-view"),
                };
                const tbody = document.getElementById("directory-tbody");
                const filterContainer =
                    document.getElementById("filter-buttons");
                const searchInput = document.getElementById("searchInput");
                const strategyDisplay =
                    document.getElementById("strategy-display");

                // --- RENDER FUNCTIONS ---

                /**
                 * Renders the main directory table based on the provided data.
                 * Builds the HTML string in memory for performance before updating the DOM.
                 * @param {Array} data - The array of directory items to render.
                 */
                function renderTable(data) {
                    if (!tbody) return; // Robustness: Exit if the table body doesn't exist.

                    if (data.length === 0) {
                        tbody.innerHTML =
                            '<tr><td colspan="4" class="text-center py-8 text-gray-500">No results found.</td></tr>';
                        return;
                    }

                    // Performance: Build the HTML string first, then update DOM once.
                    const tableHTML = data
                        .map(
                            (item) => `
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <a href="${item.url}" target="_blank" rel="noopener noreferrer" class="font-medium table-link">${item.name}</a>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.category}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${item.focus}</td>
                        <td class="px-6 py-4 text-sm text-gray-500">${item.notes}</td>
                    </tr>
                `
                        )
                        .join("");

                    tbody.innerHTML = tableHTML;
                }

                /**
                 * Creates and renders the category filter buttons.
                 */
                function setupFilters() {
                    if (!filterContainer) return;
                    const categories = [
                        "All",
                        ...new Set(directoryData.map((item) => item.category)),
                    ];

                    const buttonsHTML = categories
                        .map(
                            (category) => `
                    <button 
                        class="filter-btn px-4 py-2 border rounded-full text-sm font-medium ${
                            currentFilter === category
                                ? "active"
                                : "bg-white text-gray-700 border-gray-300 hover:bg-gray-100"
                        }"
                        data-category="${category}">
                        ${category}
                    </button>
                `
                        )
                        .join("");

                    filterContainer.innerHTML = buttonsHTML;
                }

                /**
                 * Updates the visual state of filter buttons based on the current filter.
                 */
                function updateFilterButtons() {
                    const buttons = document.querySelectorAll(".filter-btn");
                    buttons.forEach((btn) => {
                        const isActive = btn.dataset.category === currentFilter;
                        btn.classList.toggle("active", isActive);
                        btn.classList.toggle("bg-white", !isActive);
                        btn.classList.toggle("text-gray-700", !isActive);
                        btn.classList.toggle("border-gray-300", !isActive);
                        btn.classList.toggle("hover:bg-gray-100", !isActive);
                    });
                }

                /**
                 * Renders the accordion for regional data analysis.
                 */
                function setupAccordion() {
                    const container = document.getElementById(
                        "accordion-container"
                    );
                    if (!container) return;

                    container.innerHTML = regionalData
                        .map(
                            (item, index) => `
                    <div class="border-b border-gray-200">
                        <button class="w-full text-left p-4 focus:outline-none accordion-toggle" data-index="${index}">
                            <div class="flex justify-between items-center">
                                <span class="text-lg font-semibold text-[#3d405b]">${item.name}</span>
                                <span class="transform transition-transform duration-300 accordion-icon" id="accordion-icon-${index}">+</span>
                            </div>
                        </button>
                        <div id="accordion-content-${index}" class="max-h-0 overflow-hidden transition-max-height duration-500 ease-in-out">
                            <div class="p-4 pt-0 text-gray-600">
                                <p>${item.content}</p>
                            </div>
                        </div>
                    </div>
                `
                        )
                        .join("");
                }

                /**
                 * Initializes the Chart.js scatter plot.
                 */
                function initChart() {
                    const ctx = document
                        .getElementById("sourceComparisonChart")
                        ?.getContext("2d");
                    if (!ctx) return; // Exit if canvas not found

                    if (chart) {
                        chart.destroy();
                    }
                    chart = new Chart(ctx, {
                        type: "scatter",
                        data: {
                            datasets: sourceComparisonData.map((d) => ({
                                label: d.label,
                                data: [{ x: d.x, y: d.y }],
                                backgroundColor: d.color,
                                borderColor: d.color,
                                pointRadius: 15,
                                pointHoverRadius: 20,
                                // Store the filter category directly in the dataset
                                filterCategory: d.filterCategory,
                            })),
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: { position: "bottom" },
                                tooltip: {
                                    callbacks: {
                                        label: (context) =>
                                            context.dataset.label,
                                    },
                                },
                            },
                            scales: {
                                x: {
                                    title: {
                                        display: true,
                                        text: "Lead Volume Potential ‚Üí",
                                        font: { size: 14 },
                                    },
                                    min: 0,
                                    max: 5.5,
                                    ticks: { display: false },
                                },
                                y: {
                                    title: {
                                        display: true,
                                        text: "Lead Quality / Credibility ‚Üí",
                                        font: { size: 14 },
                                    },
                                    min: 0,
                                    max: 5.5,
                                    ticks: { display: false },
                                },
                            },
                            onClick: (e, elements) => {
                                if (elements.length > 0) {
                                    const datasetIndex =
                                        elements[0].datasetIndex;
                                    // Robustness: Use the stored filterCategory from the dataset
                                    const category =
                                        chart.data.datasets[datasetIndex]
                                            .filterCategory;
                                    if (category) {
                                        currentFilter = category;
                                        showView("directory"); // This will trigger applyFilters and updateFilterButtons
                                    }
                                }
                            },
                        },
                    });
                }

                // --- LOGIC & EVENT HANDLERS ---

                /**
                 * Applies the current search and category filters to the directory data.
                 */
                function applyFilters(preFilteredData = null) {
                    const searchTerm = searchInput.value.toLowerCase();
                    let sourceData = preFilteredData || directoryData;
                    let filteredData = sourceData;

                    if (currentFilter !== "All") {
                        filteredData = sourceData.filter(
                            (item) => item.category === currentFilter
                        );
                    }

                    if (searchTerm) {
                        filteredData = filteredData.filter((item) =>
                            Object.values(item).some((val) =>
                                String(val).toLowerCase().includes(searchTerm)
                            )
                        );
                    }
                    renderTable(filteredData);
                }

                /**
                 * Switches the main view between Dashboard, Directory, and Regional Analysis.
                 * @param {string} viewName - The name of the view to display ('dashboard', 'directory', 'regional').
                 */
                function showView(viewName) {
                    Object.values(views).forEach(
                        (view) => (view.style.display = "none")
                    );

                    if (views[viewName]) {
                        views[viewName].style.display = "block";
                    }

                    // Update navigation button states
                    document.querySelectorAll(".nav-button").forEach((btn) => {
                        btn.classList.toggle(
                            "active",
                            btn.dataset.view === viewName
                        );
                    });
                    document.getElementById("mobile-nav").value = viewName;

                    // Refresh filters and buttons when switching to the directory
                    if (viewName === "directory") {
                        setupFilters();
                        updateFilterButtons();
                        applyFilters();
                    }
                }

                /**
                 * Handles the selection of a strategic goal from the dashboard.
                 * @param {string} goal - The selected goal ('sales', 'partnership', 'research').
                 */
                function selectGoal(goal) {
                    const strategy = strategies[goal];
                    if (!strategy || !strategyDisplay) return;

                    document.getElementById("strategy-title").textContent =
                        strategy.title;
                    document.getElementById("strategy-text").textContent =
                        strategy.text;
                    strategyDisplay.style.display = "block";

                    // Pre-filter the data based on the goal's recommended categories
                    const goalFilteredData = directoryData.filter((item) =>
                        strategy.categories.includes(item.category)
                    );
                    currentFilter = "All"; // Reset category filter to show all relevant results for the goal

                    showView("directory");
                    applyFilters(goalFilteredData); // Pass the pre-filtered data

                    // Scroll to the directory view for immediate feedback
                    views.directory.scrollIntoView({
                        behavior: "smooth",
                        block: "start",
                    });
                }

                /**
                 * Resets the dashboard to its initial state.
                 */
                function resetDashboard() {
                    if (strategyDisplay) strategyDisplay.style.display = "none";
                    currentFilter = "All";
                    showView("dashboard");
                    // No need to call applyFilters here, as showView handles it for the directory.
                }

                // --- EVENT LISTENERS ---

                // Use event delegation for dynamically created elements
                if (filterContainer) {
                    filterContainer.addEventListener("click", (e) => {
                        if (e.target.matches(".filter-btn")) {
                            currentFilter = e.target.dataset.category;
                            applyFilters();
                            updateFilterButtons();
                        }
                    });
                }

                const accordionContainer = document.getElementById(
                    "accordion-container"
                );
                if (accordionContainer) {
                    accordionContainer.addEventListener("click", (e) => {
                        const toggle = e.target.closest(".accordion-toggle");
                        if (toggle) {
                            const index = toggle.dataset.index;
                            const content = document.getElementById(
                                `accordion-content-${index}`
                            );
                            const icon = document.getElementById(
                                `accordion-icon-${index}`
                            );
                            const isOpen =
                                content.style.maxHeight &&
                                content.style.maxHeight !== "0px";

                            // Close all other accordions for a cleaner interface
                            document
                                .querySelectorAll(".accordion-content")
                                .forEach(
                                    (acc) => (acc.style.maxHeight = "0px")
                                );
                            document
                                .querySelectorAll(".accordion-icon")
                                .forEach((ico) =>
                                    ico.classList.remove("rotate-45")
                                );

                            if (!isOpen) {
                                content.style.maxHeight =
                                    content.scrollHeight + "px";
                                icon.classList.add("rotate-45");
                            }
                        }
                    });
                }

                // Standard event listeners
                searchInput?.addEventListener("input", () => applyFilters());
                document
                    .getElementById("mobile-nav")
                    ?.addEventListener("change", (e) =>
                        showView(e.target.value)
                    );
                document
                    .getElementById("desktop-nav")
                    ?.addEventListener("click", (e) => {
                        if (e.target.matches(".nav-button")) {
                            showView(e.target.dataset.view);
                        }
                    });
                document
                    .getElementById("goal-selector")
                    ?.addEventListener("click", (e) => {
                        const card = e.target.closest(".goal-card");
                        if (card && card.dataset.goal) {
                            selectGoal(card.dataset.goal);
                        }
                    });
                document
                    .getElementById("reset-dashboard-btn")
                    ?.addEventListener("click", resetDashboard);

                // --- INITIALIZATION ---
                renderTable(directoryData);
                setupFilters();
                initChart();
                setupAccordion();
                showView("dashboard"); // Start on the dashboard view
            });
        </script>
    </body>
</html>
